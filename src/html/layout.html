<!DOCTYPE html>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<title>{{title}}</title>
{{#description}}<meta name="description" content="{{description}}">{{/description}}
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="{{{assetUrl}}}index.css">

<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
<script>
  $(function() {
    $('form').on('click', 'button', function(e) {
      var $form = $(this).closest('form');

      var data = $form.serialize();

      if ($form.is('#signup')) {
        var signupData = {
          user: {
            email: $('#email').val(),
            password: $('#password').val()
          },
          site: {
            name: $('#name').val(),
            options: '{"color": "black"}'
          },
          parts: [
            {
              type: 1,
              rank: 1337,
              content: '{"text": "lorem ipsum"}',
            }, {
              type: 1,
              rank: 1337,
              content: '{"text": "lorem ipsum"}',
            }
          ]
        }
      }

      $.ajax({
        url: $form.attr('action'),
        type: 'post',
        dataType: 'json',
        data: $form.is('#signup') ? signupData : data,
        success: function(data) {
          console.log(data)

          if (($form.is('#signin')) && data.id) {
            location.reload();
          }

          if (($form.is('#signup')) && data.name) {
            window.location = '/by/' + data.name;
          }
        },
        error: function(data) {
          console.log('Got error');
        }
      });

      e.preventDefault();
    });
  });
</script>

{{^activeUser}}
<form id="signin" action="/api/signin" method="post">
  <input name="email" type="text" placeholder="Email">
  <input name="password" type="password" placeholder="Password">
  <button type="submit">Sign in</button>
</form>
{{/activeUser}}

{{#activeUser}}
<a href="/signout">Signout</a>
{{/activeUser}}



{{#index}}
{{^activeUser}}
<form id="signup" action="/api/publish-with-user" method="post">
  <input id="name" name="name" type="text" placeholder="Site name">
  <input id="email" name="email" type="text" placeholder="Email">
  <input id="password" name="password" type="password" placeholder="Password">
  <button type="submit">Publish page</button>
</form>
{{/activeUser}}
{{/index}}


{{#userSite}}
{{#parts}}
<p>
  item type: {{{rank}}}
  {{#editMode}} EDIT {{/editMode}}
</p>
{{/parts}}

{{#editMode}}
<form id="addPart" action="/api/add-part" method="post">
  <input name="siteId" type="text" placeholder="SiteId" value="{{id}}">
  <input name="type" type="text" placeholder="Type" value="1">
  <input name="rank" type="number" placeholder="Rank" value="0">
  <input name="content" type="text" placeholder="Content" value='{"text": "lorem ipsum"}'>

  <button type="submit">Add part</button>
</form>
{{/editMode}}
{{/userSite}}


{{#dump}}
{{{dump}}}
{{/dump}}

{{#serverError}}
<h1>Damn it. 505 server error</h1>
{{/serverError}}

{{#notFound}}
<h1>Woops. 404 not found</h1>
{{/notFound}}

{{> symbols}}

<script>
  var DATA = {}

  // Trigger svg redraw (safari issue)
  document.addEventListener('DOMContentLoaded', function(){
    var elms = document.getElementsByTagName('use');
    Array.prototype.forEach.call(elms, function(el, i){
      var href = el.getAttribute('xlink:href');
      el.setAttribute('xlink:href', href);
    });
  });

  {{#analyticsCode}}
  // Google analytics
  /* (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', '{{{analyticsCode}}}', 'auto');
  ga('require', 'displayfeatures');
  ga('send', 'pageview'); */
  {{/analyticsCode}}
</script>