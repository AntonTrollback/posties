<!DOCTYPE html>
<html>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<title>Database converter</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="{{{assetUrl}}}posties.css">
<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
<style>
  body {
    margin: 20px;
  }
  .output {
    font-size: 10px;
    font-family: monospace;
    box-sizing: border-box;
    height: 300px;
    border: 1px solid #ccc;
    background: white;
    width: 100%;
    resize: vertical;
  }

  div {
    width: 33.333333%;
    float: left;
    overflow: hidden;
  }

  span {
    margin-bottom: 10px;
    display: block;
  }
</style>

<script>
  $(function() {
    var old_users = JSON.parse($('.users').html());
    var old_sites = JSON.parse($('.sites').html());
    var old_parts = JSON.parse($('.parts').html());
    var users = [];
    var uniqueUsers = []
    var sites = [];
    var fixedSites = []
    var parts = [];

    doit();

    function doit() {

      // create an array of users
      for (var i = old_users.length - 1; i >= 0; i--) {
        var user = {
          temp_name: old_users[i].username,

          email: old_users[i].email,
          password: old_users[i].password,
          created: new Date(old_users[i].created.epoch_time * 1000).toISOString()
        }
        users.push(user);
      }

      // create an array of sites
      for (var i = old_sites.length - 1; i >= 0; i--) {
        var old = old_sites[i];
        var owner = get_owner(old.username, users);

        if (owner === null) {
          continue;
        }

        var site = {
          // save owner email
          temp_user_email: owner.email,
          name: old.username,
          updated: new Date(old.created.epoch_time * 1000).toISOString(),
          created: new Date(old.created.epoch_time * 1000).toISOString(),
          options: {
            boxes: old.showboxes,
            text_font: old.typefaceparagraph,
            text_color: old.posttextcolor,
            heading_font: old.typefaceheadline,
            background_color: old.pagebackgroundcolor,
            part_background_color: old.postbackgroundcolor
          }
        }
        sites.push(site);
      }

      // set id's to sites
      for (var i = sites.length - 1; i >= 0; i--) {
        sites[i].id = i;
        fixedSites.push(sites[i]);
      }

      // Make array of unique users
      var emails = []

      for (var i = users.length - 1; i >= 0; i--) {

        if (emails.indexOf(users[i].email) > -1) {
        } else {
          emails.push(users[i].email);
          uniqueUsers.push(users[i]);
        }
      }

      // set id's to users
      for (var i = uniqueUsers.length - 1; i >= 0; i--) {
        uniqueUsers[i].id = i;
      }

      // add user_id's to sites
      for (var i = sites.length - 1; i >= 0; i--) {
        sites[i].user_id = get_owner_id_by_email(sites[i].temp_user_email, uniqueUsers, 'id');
      }

      setTimeout(function(){
        // make array of parts
        for (var i = old_parts.length - 1; i >= 0; i--) {
          var old = old_parts[i];
          var site_id = get_site_id(old.username);
          var part = {
            site_id: site_id,
            type: old.type,
            rank: old.sortrank,
            content: get_content(old.type, old.content, old.key),
            created: new Date(old.created.epoch_time * 1000).toISOString()
          }
          if (part.site_id !== null) {
            parts.push(part);
          }
        }
        // set id's to parts
        for (var i = parts.length - 1; i >= 0; i--) {
          parts[i].id = i;
        }

        output();
      }, 100);
    }

    function get_site_id(username) {
      var match = $.grep(fixedSites, function(e) {
        return e.name === username;
      });

      if (match.length === 1) {
        console.log(match[0].id)
        return match[0].id;
      } else if (match.length === 0) {
        return null;
      } else {
        return match[0].id;
      }
    }

    function get_owner(username, table, keyName) {
      var match = $.grep(table, function(e) {
        return e.temp_name === username;
      });

      if (match.length === 1) {
        return match[0];
      } else if (match.length === 0) {
        //console.log('missing ' + keyName + ' for "' + username + '"')
        return null;
      } else {
        //console.log('multiple ' + keyName + ' for "' + username + '"')
        return match[0];
      }
    }

    function get_owner_id_by_email(email, table, keyName) {
      var match = $.grep(table, function(e) {
        return e.email === email;
      });

      if (match.length === 1) {
        return match[0][keyName];
      } else if (match.length === 0) {
        //console.log('missing ' + keyName + ' for "' + username + '"')
        return null;
      } else {
        //console.log('multiple ' + keyName + ' for "' + username + '"')
        return match[0][keyName];
      }
    }

    function get_content(type, content, key) {
      if (type === 0 || type === 1) {
        return {text: content};
      } else {
        return {key: key};
      }
    }

    function log_duplicate_user() {
      for (var i = users.length - 1; i >= 0; i--) {
        var match = $.grep(users, function(e) {
          return e.email === users[i].email;
        });

        if (match.length > 1) {
          console.log(match);
        }
      }
      console.log('\n\n')
    }

    function fix_json(obj) {
      string = JSON.stringify(obj)
      return string.replace(/"/g, '""');
    }

    function output () {
      //var userOutput = ['"id","email","password","created"'];
      var userOutput = [];
      for (var i = uniqueUsers.length - 1; i >= 0; i--) {
        userOutput.unshift(
          uniqueUsers[i].id + ',' +
          uniqueUsers[i].email + ',' +
          uniqueUsers[i].password + ',' +
          '"' + uniqueUsers[i].created+ '"'
        )
      }

      //var siteOutput = ['"id","user_id","name","options","updated","created"'];
      var siteOutput = [];
      for (var i = sites.length - 1; i >= 0; i--) {
        siteOutput.unshift(
          sites[i].id + ',' +
          sites[i].user_id + ',' +
          sites[i].name + ',' +
          '"' + fix_json(sites[i].options) + '",' +
          '"' + sites[i].updated + '",' +
          '"' + sites[i].created+ '"'
        )
      }

      //var partOutput = ['"id","site_id","type","rank","content","created"'];
      var partOutput = [];
      for (var i = parts.length - 1; i >= 0; i--) {
        partOutput.unshift(
          parts[i].id + ',' +
          parts[i].site_id + ',' +
          parts[i].type + ',' +
          parts[i].rank + ',' +
          '"' + fix_json(parts[i].content) + '",' +
          '"' + parts[i].created+ '"'
        )
      }
      console.log('users:', userOutput.length)
      console.log('sites:', siteOutput.length)
      console.log('parts:', partOutput.length)

      $('.output-users').text(userOutput.join('\n'));
      $('.output-sites').text(siteOutput.join('\n'));
      $('.output-parts').text(partOutput.join('\n'));
    }

  });
</script>

<div>
  <span>users</span>
  <textarea class="output output-users"></textarea>
</div>
<div>
  <span>sites</span>
  <textarea class="output output-sites"></textarea>
</div>
<div>
  <span>parts</span>
  <textarea class="output output-parts"></textarea>
</div>

<!--

users
  id (serial primary key)
  email (text)
  password (text)
  created (timestamptz)

sites
  id (serial primary key)
  user_id (serial)
  name (text)
  options (jsonb)
  updated (timestamptz)
  created (timestamptz)

parts
  id (serial primary key)
  site_id (serial)
  type (smallint)
  rank (integer)
  content (jsonb)
  created (timestamptz)
-->

{{>data}}